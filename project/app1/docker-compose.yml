version: "3.9"

services:

  # --------------------------
  # PostgreSQL database
  # --------------------------
  postgres:
    image: postgres:16
    container_name: postgres_db
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: admin
      POSTGRES_DB: mydb
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data

  # --------------------------
  # Python API service
  # --------------------------
  api:
    build: .
    container_name: api_service
    depends_on:
      - postgres
      - kdb
    environment:
      DATABASE_URL: postgres://postgres:admin@postgres:5432/mydb
      KDB_HOST: kdb
      KDB_PORT: 5000
    ports:
      - "8000:8000"
    volumes:
      - .:/app

  # --------------------------
  # KDB+ Gateway
  # --------------------------
  kdb:
    image: kxsys/q:latest
    container_name: kdb_gateway
    environment:
      KDB_LICENSE_ACCEPT: "yes"
    command: q -p 5000
    ports:
      - "5000:5000"
    volumes:
      - ./kdb:/kdb

volumes:
  pgdata:
